jQuery(function(e){var t=e(".wpcm-vehicle-listings");t&&e.each(t,function(e,t){new WPCM_Listings(t)})});var WPCM_Listings=function(e){this.is_updating=!1,this.nonce=jQuery(e).find("#wpcm-listings-nonce").val(),this.filters=jQuery(e).find(".wpcm-vehicle-filters:first"),this.sort=jQuery(e).find("#wpcm-sort:first"),this.listings=jQuery(e).find(".wpcm-vehicle-results-wrapper>.wpcm-vehicle-results:first"),this.pagination=jQuery(e).find(".wpcm-vehicle-listings-pagination:first"),this.page=1,this.default_sort=jQuery(e).data("sort"),this.condition=jQuery(e).data("condition"),this.featured=jQuery(e).data("featured"),this.per_page=jQuery(e).data("per_page"),this.exclude_id=jQuery(e).data("exclude_id"),this.locked_make=0,jQuery(e).data("make_id")&&(this.locked_make=jQuery(e).data("make_id")),this.locked_model=0,jQuery(e).data("model_id")&&(this.locked_model=jQuery(e).data("model_id")),this.init_filters(),this.sort.length>0&&this.init_sort(),this.updateModels(),this.load_vehicles()};WPCM_Listings.prototype.init_filters=function(){var e=this;jQuery.each(this.filters.find("select"),function(e,t){jQuery(t).select2({placeholder:jQuery(t).data("placeholder"),width:"resolve"})}),this.filters.find(".wpcm-filter-make select").change(function(){e.updateModels()}),this.filters.find(".wpcm-filter-button input").click(function(){e.page=1,e.load_vehicles()})},WPCM_Listings.prototype.init_sort=function(){var e=this;this.sort.change(function(){e.page=1,e.load_vehicles()})},WPCM_Listings.prototype.updateModels=function(){var e=this.filters.find(".wpcm-filter-make select option:selected").val(),t=this.filters.find(".wpcm-filter-model select");if(e>0){var i={nonce:wpcm.nonce_models,make:e};jQuery.get(wpcm.ajax_url_get_models,i,function(e){if(t.attr("disabled",!1).find("option").remove(),null!=e&&""!=e&&0!=e&&e.length>0){t.append(jQuery("<option>").val(0).html(t.data("placeholder")));for(var i=0;i<e.length;i++)t.append(jQuery("<option>").val(e[i].id).html(e[i].name))}else t.append(jQuery("<option>").val(0).html(wpcm.lbl_no_models_found));t.select2({width:"resolve"})})}else t.attr("disabled",!0).find("option").remove().end().append(jQuery("<option>").val(0).html(wpcm.lbl_select_make_first)).select2({width:"resolve"})},WPCM_Listings.prototype.load_vehicles=function(){if(1!=this.is_updating){this.is_updating=!0;var e=this,t=this.listings,i=this.pagination,n={nonce:this.nonce,page:this.page};jQuery.each(this.filters.find(".wpcm-filter select"),function(e,t){var i=jQuery(t).find("option:selected").val();0!=i&&(n["filter_"+jQuery(t).attr("name")]=i)}),jQuery.each(this.filters.find(".wpcm-filter input[type=hidden]"),function(e,t){var i=jQuery(t).val();i&&(n["filter_"+jQuery(t).attr("name")]=i)}),this.locked_make>0&&(n.filter_make=this.locked_make),this.locked_model>0&&(n.filter_model=this.locked_model),this.sort.length>0?n.sort=this.sort.find("option:selected").val():n.sort=this.default_sort,""!=this.condition&&(n.filter_condition=this.condition),null!=this.featured&&(n.filter_featured=this.featured),null!=this.per_page&&(n.per_page=this.per_page),null!=this.exclude_id&&(n.filter_exclude_id=this.exclude_id),this.listings.parent().append(jQuery("<div>").addClass("wpcm-results-load-overlay")),this.listings.parent().append((new WPCM_Spinner).getDOM()),jQuery.getJSON(wpcm.ajax_url_get_vehicles,n,function(n){n.listings&&t.html(n.listings),n.pagination?(i.html(n.pagination),e.bind_pagination()):i.html(""),t.parent().find(".wpcm-results-load-overlay").remove(),t.parent().find(".wpcm-results-spinner").remove(),e.is_updating=!1})}},WPCM_Listings.prototype.bind_pagination=function(){var e=this;jQuery.each(jQuery(this.pagination).find("a"),function(t,i){jQuery(i).click(function(){var t=jQuery(i).data("page");"next"==t&&(t=e.page+1),"prev"==t&&(t=e.page-1),e.page=t,e.load_vehicles()})})};var WPCM_Spinner=function(){return this.el=jQuery("<div>").addClass("wpcm-results-spinner").fadeIn(400,WPCM_Spinner.prototype.fadeOut),jQuery(this.el).bind("fade",function(){jQuery(this).fadeOut("slow",function(){jQuery(this).fadeIn("slow",function(){jQuery(this).trigger("fade")})})}),jQuery(this.el).trigger("fade"),this};WPCM_Spinner.prototype.getDOM=function(){return this.el};